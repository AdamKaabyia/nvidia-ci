name: Generate test matrices pages

on:
  pull_request:
    branches:
      - main
    types: [closed]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to check out'
        default: 'main'
        required: false
        type: string
      pr_number:
        description: 'PR number to process (must be specified as a number or "all")'
        required: false
        type: string
  
jobs:
  generate-matrix:
    if: github.event_name != 'pull_request' || github.repository == 'rh-ecosystem-edge/nvidia-ci' 
    runs-on: ubuntu-latest
    env:
      OUTPUT_DIR: 'workflows/test_matrix_dashboard/output'
      OLD_OCP_FILE: 'old_ocp_data.json'
      OCP_FILE: 'ocp_data.json'
    steps:
      - name: Determine PR Number
        id: determine_pr
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
              echo "Processing all PR history for merged pull request."
              echo "PR_NUMBER=all" >> "$GITHUB_OUTPUT"
          else
              if [ -z "${{ github.event.inputs.pr_number }}" ]; then
                  echo "Error: The pr_number input is required. Please specify a PR number or 'all'."
                  exit 1
              else
              echo "Using manually specified PR: ${{ github.event.inputs.pr_number }}"
              echo "PR_NUMBER=${{ github.event.inputs.pr_number }}" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Checkout the gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages  # Explicitly checking out the gh-pages branch
        
      - name: List files in gh-pages branch (for debugging)
        run: |
          ls -R  # List all files recursively to verify the file path
  
      - name: Copy ocp_data.json to workspace
        run: |
          cp ${{ env.OCP_FILE }} ${{ env.OLD_OCP_FILE }}  # Ensure the file exists and is in the correct directory
  
      - name: Checkout Code (PR or main branch)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.event.inputs.branch }}
          


#this doesnt work will look into it in the future
      # - name: Get ocp_data.json from gh-pages branch
      #   uses: dawidd6/action-get-file@v4
      #   with:
      #     repository: ${{ github.repository }}
      #     ref: gh-pages
      #     path: ${{ env.OCP_FILE }}
      #     destination: ${{ env.OLD_OCP_FILE }}   

#we could use this instead of the checkout and copying:
      # - name: Download ocp_data.json from gh-pages branch using curl
      #   run: |
      #     curl -L -o ${{ env.OLD_OCP_FILE }} \
      #     https://github.com/${{ github.repository }}/raw/gh-pages/${{ env.OCP_FILE }}


      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Dependencies
        run: |
          pip install -r workflows/test_matrix_dashboard/requirements.txt

      - name: Run Extraction Script
        run: |
          echo "Processing PR: ${{ steps.determine_pr.outputs.PR_NUMBER }}"
          python workflows/test_matrix_dashboard/generate_test_matrix_data.py \
            --pr "${{ steps.determine_pr.outputs.PR_NUMBER }}" \
            --output_dir "${OUTPUT_DIR}" \
            --old_data_file ${{ env.OLD_OCP_FILE }}
        
      - name: Archive old ocp_data file
        run: |
          echo "Archiving ${{ env.OLD_OCP_FILE }} into output directory..."
          cp ${{ env.OLD_OCP_FILE }} ${OUTPUT_DIR}/${{ env.OLD_OCP_FILE }}

      - name: Generate UI
        run: |
          echo "Generating UI using output from ${OUTPUT_DIR}"
          python workflows/test_matrix_dashboard/generate_test_matrix_ui.py --output_dir "${OUTPUT_DIR}"

      - name: Deploy HTML to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: ${{ env.OUTPUT_DIR }}
