name: PR Comment Update Workflow

on:
  issue_comment:
    types: [created]

jobs:
  update-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Extract comment from PR
        run: |
          PR_COMMENT_BODY=$(jq --raw-output .comment.body "$GITHUB_EVENT_PATH")
          PR_NUMBER=$(jq --raw-output .issue.number "$GITHUB_EVENT_PATH")
          echo "Extracted comment: $PR_COMMENT_BODY"
          echo "PR Number: $PR_NUMBER"

          # Create the JSON file or update it
          FILE_NAME="pr_comments.json"
          if [[ ! -f "$FILE_NAME" ]]; then
            echo "[]" > "$FILE_NAME"  # Create an empty JSON file if it doesn't exist
          fi

          # Update JSON with new comment
          UPDATED_JSON=$(jq --arg pr_number "$PR_NUMBER" --arg comment "$PR_COMMENT_BODY" \
            '. += [{"pr_number": $pr_number, "comment": $comment}]' "$FILE_NAME")

          echo "$UPDATED_JSON" > "$FILE_NAME"
        
      - name: Commit and push changes
        uses: EndBug/add-and-commit@v7
        with:
          message: "Update PR comments in JSON"
          add: "pr_comments.json"
          push: "true"
